name: CI
on:
  push:
    branches: [ master ]
#   pull_request:
#     branches: [ master ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  build:
    name: Build the production artifact
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Setup Java environment
        uses: actions/setup-java@v1
        with:
          java-version: 12.x

      - name: Setup Flutter environment
        uses: subosito/flutter-action@v1
        with:
          channel: 'stable'

      - name: Decrypt google services 
        run: ./.github/scripts/decrypt-google-services.sh
        env:
          GOOGLE_SERVICES_SECRET: ${{ secrets.GOOGLE_SERVICES_SECRET }}

      - name: Decrypt signing keys 
        run: ./.github/scripts/decrypt-upload-key.sh
        env:
          UPLOAD_KEY_SECRET: ${{ secrets.UPLOAD_KEY_SECRET }}
      
      - name: Replace admob app id
        uses: datamonsters/replace-action@v2
        with:
          files: "android/app/src/prod/res/values/strings.xml, lib/main_prod.dart"
          replacements: 'ca-app-pub-xxxxxxxxxxxxxxxx~xxxxxxxxxx=${{ secrets.AD_MOB_APP_ID }}'
      
      - name: Replace admob banner unit id
        uses: datamonsters/replace-action@v2
        with:
          files: "lib/main_prod.dart"
          replacements: 'ca-app-pub-xxxxxxxxxxxxxxxx/xxxxxxxxxx=${{ secrets.AD_MOB_BANNER_UNIT_ID }}'

      - name: Fetch package dependencies
        run: flutter pub get

      - name: Build the bundle
        run: flutter build appbundle --flavor prod -t lib/main_prod.dart --build-number=${GITHUB_RUN_NUMBER}
      
      - name: Generate apk
      - run: |
          curl -L https://github.com/google/bundletool/releases/download/1.4.0/bundletool-all-1.4.0.jar --output bundletool.jar
          java -jar bundletool.jar build-apks --bundle=build/app/outputs/bundle/prodRelease/app-prod-release.aab --output=app-prod-release.apks --mode=universal
          mv app-prod-release.apks app-prod-release.zip
          unzip app-prod-release.zip

      - name: Upload artifacts
        uses: actions/upload-artifact@v1
        with:
          name: release-apk
          path: universal.apk
      
      - name: Publish to Google Play Console
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.SERVICE_ACCOUNT_JSON }}
          packageName: dev.stofberg.moonshot
          releaseFiles: build/app/outputs/bundle/prodRelease/app-prod-release.aab
          track: internal
          mappingFile: build/app/outputs/mapping/prod/release/mapping.txt
